//
//  LottoWinningCheckView.swift
//  Lattery
//
//  Created by dodor on 12/7/23.
//

import SwiftUI

struct LottoWinningCheckView: View {
    
    @StateObject var viewModel: LottoWinningCheckViewModel
    
    var body: some View {
        VStack(spacing: 20) {
            HStack(spacing: 8) {
                Image(systemName: "speaker.wave.2")
                Text("Îß§Ï£º ÌÜ†ÏöîÏùº Ïò§ÌõÑ 8Ïãú 35Î∂ÑÍ≤Ω Î∞úÌëú")
                Spacer()
            }
            .foregroundColor(.gray1)
            
            if viewModel.lottos.count < 1 {
                EmptyLottoDataView()
            } else {
                SelectedLottoResult(viewModel: viewModel)
                SelectedDrawingLotResult(viewModel: viewModel)
            }
            
        }
    }
}

private struct SelectedLottoResult: View {
    
    @ObservedObject var viewModel: LottoWinningCheckViewModel
    
    fileprivate var body: some View {
        VStack(spacing: 8) {
            HStack {
                Text("Î°úÎòê ÌöåÏ∞®")
                    .font(.headline)
                
                Spacer()
                
                if viewModel.lottos.count > 0 {
                    Picker("", selection: $viewModel.selectedLotto) {
                        ForEach(viewModel.lottos, id: \.self) { lotto in
                            Text(verbatim: "\(lotto.round)Ìöå")
                                .foregroundColor(.gray2)
                                .tag(lotto)
                        }
                    }
                    .pickerStyle(.menu)
                } else {
                    Text("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§")
                        .font(.subheadline)
                        .foregroundColor(.gray2)
                }
            }
            
            Group {
                if viewModel.winningNumbers.count == 6 {
                    resultBoard
                } else {
                    EmptyLottoDataView()
                        .frame(maxHeight: 150)
                }
            }
            .background(Color.backgroundGray)
            .cornerRadius(10)
        }
    }
    
    var resultBoard: some View {
        VStack(spacing: 4) {
            Text(verbatim: "\(viewModel.selectedLotto?.round)Ìöå ÎãπÏ≤®Í≤∞Í≥º")
                .font(.title)
                .bold()
                .foregroundStyle(Color.primaryColor)
            
            Text("(\(viewModel.selectedLotto?.date.toDateStringKor ?? "YYYYÎÖÑ MMÏõî ddÏùº") Ï∂îÏ≤®)")
                .font(.caption)
                .foregroundStyle(Color.gray2)
            
            HStack(spacing: 4) {
                VStack(spacing: 4) {
                    HStack(spacing: 8) {
                        ForEach(viewModel.winningNumbers, id:\.self) { number in
                            LottoBall(number: number)
                        }
                    }
                    .padding(8)
                    .background(Color.pureBackground)
                    .cornerRadius(10)
                    
                    Text("ÎãπÏ≤®Î≤àÌò∏")
                        .font(.caption)
                        .foregroundStyle(Color.primaryColor)
                }
                
                Image(systemName: "plus")
                    .foregroundColor(.gray2)
                
                VStack(spacing: 4) {
                    HStack(spacing: 8) {
                        LottoBall(number: viewModel.bonus)
                    }
                    .padding(8)
                    .background(Color.pureBackground)
                    .cornerRadius(10)
                    
                    Text("Î≥¥ÎÑàÏä§")
                        .font(.caption)
                        .foregroundStyle(Color.primaryColor)
                }
            }
        }
    }
}

private struct SelectedDrawingLotResult: View {
    
    @ObservedObject var viewModel: LottoWinningCheckViewModel
    
    fileprivate var body: some View {
        VStack(spacing: 16) {
            VStack(spacing: 8) {
                HStack {
                    Text("Ï†ÄÏû•Ìïú Ï∂îÏ≤®Î≤àÌò∏")
                        .font(.headline)
                        .foregroundStyle(Color.primaryColor)
                    Spacer()
                }
                
                HStack {
                    Spacer()
                    if viewModel.drawingLotResults.count > 0 {
                        Picker("", selection: $viewModel.selectedResult) {
                            ForEach(viewModel.drawingLotResults, id: \.self) { result in
                                Text("\(result.date.toDateTimeKor) Ï∂îÏ≤®Î≤àÌò∏")
                                    .foregroundColor(.gray2)
                                    .tag(result)
                            }
                        }
                        .pickerStyle(.menu)
                    } else {
                        Text("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§")
                            .font(.subheadline)
                            .foregroundColor(.gray2)
                    }
                }
            }
            
            if viewModel.selectedResult != nil {
                compareBoard
            }
        }
    }
    
    var compareBoard: some View {
        ScrollView {
            Divider()
            VStack(spacing: 8) {
                ForEach(viewModel.resultNumbers, id:\.self) { number in
                    CheckRow(viewModel: viewModel,
                             result: number)
                    Divider()
                }
            }
        }
    }
}

private struct CheckRow: View {
    
    @ObservedObject var viewModel: LottoWinningCheckViewModel
    let result: LottoNumbers
    
    private var rank: String {
        let include: [Int] = viewModel.winningNumbers.filter({ result.numbers.contains($0) })
        if include.count == 6 {
            return "1Îì±ü•á"
        } else if include.count == 5 && result.numbers.contains(viewModel.bonus) {
            return "2Îì±ü•à"
        } else if include.count == 5 {
            return "3Îì±ü•â"
        } else if include.count == 4 {
            return "4Îì±"
        } else if include.count == 3 {
            return "5Îì±"
        } else {
            return "ÎÇôÏ≤®"
        }
    }
    
    fileprivate init(viewModel: LottoWinningCheckViewModel,
                     result: LottoNumbers) {
        self.viewModel = viewModel
        self.result = result
    }
    
    fileprivate var body: some View {
        HStack {
            Spacer()
            Text(rank)
                .multilineTextAlignment(.center)
                .font(.headline)
            
            Spacer()
            HStack(spacing: 8) {
                ForEach(result.numbers, id:\.self) { number in
                    LottoBall(number: number,
                              fixed: result.fixedNumbers.contains(number))
                }
            }
            Spacer()
        }
    }
}

#Preview {
    LottoWinningCheckView(viewModel: .init())
}
